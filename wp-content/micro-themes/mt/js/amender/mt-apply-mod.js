import ElementDataHandler from"./mt-data-handler.js";export default class ApplyMod{constructor(e){this.amender=window.amender||{},this.timers={},this.isEditing=this.amender.isEditing,this.TvrEventManager=e,this.elementData=new ElementDataHandler(this.isEditing)}getSnippetData(e){return this.elementData.get(e)}useCodeEditor(e,t,i){return["html","innerHTML","css","js","jsFunction"].includes(t)}isUndoAble(e){return this.isEditing||e.toggle}addUndo(e,t,i){t.noUndo||t.isUndo||!this.isUndoAble(t)||(i.elements=Array.isArray(e)?e:[e],t.mod?.snippet_id&&(i.snippet_id=t.mod.snippet_id),t.undo.push(i))}undo(e,t){(Array.isArray(e)?e:[e]).forEach((e=>{e.snippet_id&&this.elementData.clear(e.elements,e.snippet_id),e.elements.forEach((i=>{this.execute({isUndo:1,mod:e},i,{},t)}))}))}createFragment(e){return document.createRange().createContextualFragment(e)}getElementIndex(e,t,i){return this.TvrEventManager.isValidSelector(t)&&(i=i||document.querySelectorAll(t)).indexOf(e)||0}execute(e,t,i,r){let n,a=e.mod,s=a.action?a.action.trim():"";const l=a.aspect?a.aspect.trim():"html",o=a.text||"",d=a.snippet_id?a.snippet_id.trim():"",c=a.find||"";let p="text"===l;n=a.liveEl?a.liveEl:!a.forceText&&d&&this.amender.snippets?this.amender.snippets[d]||"":o;const m=""===n||null===n,h="replace"===s&&m&&!e.isUndo,u=!(e.isUndo||a.enable||"remove"!==s&&"lazyLoad"!==s);if(!(!s||h||u||"replaceSubstring"===s&&""===c))try{if("html"===l||"innerHTML"===l||"text"===l)switch(s){case"prepend":case"append":case"add":case"insertBefore":case"insertAfter":m||this.insert(s,l,t,n,p,e);break;case"replace":case"replaceSubstring":this.replace(s,l,t,n,p,e,c);break;case"lazyLoad":this.lazyLoad(a,s,l,t,p,e);break;case"move":this.move(s,l,t,p,e);break;case"remove":this.remove(s,l,t,p,e)}else if("childWrapper"===l||"parentWrapper"===l){let i="parentWrapper"===l;switch(s){case"add":case"prepend":case"append":(a.tag||a.liveEl)&&this.addWrapper(e,l,t,a.tag,n,i);break;case"remove":this.removeWrapper(e,l,t,i)}}else if(this.isAttribute(l)){let i=this.getAllAttributes(t);if("attributesString"===l)switch(s){case"add":case"prepend":case"append":case"insertBefore":case"insertAfter":case"replace":this.applyAttributesFromString(t,n);break;case"remove":this.removeAllAttributes(t);break;case"replaceSubstring":n=this.substringReplace(i,c,n),this.removeAllAttributes(t),this.applyAttributesFromString(t,n)}else{const i=l;switch("class"===i||"style"===i?"add"===s&&(s="append"):"add"===s&&(s="replace"),s){case"prepend":case"append":case"insertBefore":case"insertAfter":m||this.insertAttribute(s,i,t,n,e);break;case"replace":case"replaceSubstring":"replaceSubstring"===s&&(n=this.substringReplace(t.getAttribute(i),c,n)),t.setAttribute(i,n);break;case"remove":t.removeAttribute(i)}}this.addUndo(t,e,[{elements:[t],action:"remove",aspect:"attributesString"},{elements:[t],action:"add",aspect:"attributesString",text:i,forceText:1}]),this.elementData.attach(t,e.mod.snippet_id,e.isUndo)}else if("jsFunction"===l){if("serverHTMLReady"===r||!0===this.TvrEventManager.initialModsDone&&i.isDomEvent)return;if("run"===s){const r=this.amender.funcNameMap[d]||"";if(r&&window.AF&&window.AF[r])if(a.meta?.delay){let n=a.meta.delay;this.timers[r]||(this.timers[r]=setTimeout((()=>{this.executeSafely(r,t,i,e),delete this.timers[r]}),n))}else this.executeSafely(r,t,i,e)}}}catch(e){console.warn("Failed to execute Amender change",e)}}executeSafely(e,t,i,r){try{window.AF[e].apply(window.AF,[t,i]),this.elementData.attach(t,r.mod.snippet_id,r.isUndo)}catch(t){this.logUserError(t,e)}}logUserError(e,t){const{TvrUi:i}=this.TvrEventManager.getMTReferences();if(i){const r=i.extractErrorDetails(e,t);let n=`Error in your function "${r.functionName}": ${r.message}`;i.process_error("front",n,r.url,r.line,r.col)}}htmlTagRegex(e){return/^\s*(<\s*([a-zA-Z0-9]+)[^>]*>(?:([\s\S]*?)<\s*\/\s*\2\s*>|\s*)?)\s*$/}isPureTag(e){return e.match(/^\s*</)&&e.match(/>\s*$/)}maybeWrapWithTag(e,t){let i=e.match(this.htmlTagRegex());if(!(!i||!this.isPureTag(e)))return e;let r=!i||["span","a","strong","em","img","br","i","b","u","small","mark","q","cite","code","kbd","var","abbr","time","sub","sup","button","label","input","textarea","select","option"].includes(i[2])?"span":"div";return t.wrapper=1,"<"+r+">"+e+"</"+r+">"}isDomEntity(e){return e instanceof DocumentFragment||e instanceof Element||e instanceof NodeList||e instanceof HTMLCollection}isValidHtmlFragment(e){if("string"!=typeof e||""===e.trim())return!0;try{const t=document.createRange();return t.createContextualFragment(e).childNodes.length>0}catch(e){return!1}}insert(e,t,i,r,n,a){if(!i)return;let s,l=[],o={};if(a.mod.liveEl||this.isDomEntity(r))s=this.maybeUnwrapArtificial(r);else{if(!this.isValidHtmlFragment(r))return;r=this.maybeWrapWithTag(r,o),s=this.createFragment(r),o.wrapper&&s.firstElementChild&&(s.firstElementChild.isArtificialWrapper=!0)}const d=i.firstChild,c=i.lastChild,p=i.previousSibling,m=i.nextSibling;switch(e){case"prepend":i.prepend(s);let e=i.firstChild;for(;e&&e!==d;)l.push(e),e=e.nextSibling;break;case"append":case"add":i.appendChild(s);let t=c?c.nextSibling:i.firstChild;for(;t;)l.push(t),t=t.nextSibling;break;case"insertBefore":i.parentNode.insertBefore(s,i);let r=p?p.nextSibling:i.parentNode.firstChild;for(;r&&r!==i;)l.push(r),r=r.nextSibling;break;case"insertAfter":m?i.parentNode.insertBefore(s,m):i.parentNode.appendChild(s);let n=i.nextSibling;for(;n&&n!==m;)l.push(n),n=n.nextSibling}this.elementData.attach(i,a.mod.snippet_id,a.isUndo),this.elementData.attach(l,a.mod.snippet_id,a.isUndo),this.addUndo(l,a,{action:"remove",aspect:"html"})}insertAttribute(e,t,i,r,n){let a=i.getAttribute(t),s=i.getAttribute(t)||"",l="class"===t?" ":"";""!==r&&("prepend"===e||"insertBefore"===e?this.prependAttribute(i,t,r,s,l):this.appendAttribute(i,t,r,s,l),this.addUndo(i,n,{action:"replace",aspect:t,text:a,forceText:1}))}prependAttribute(e,t,i,r,n){e.setAttribute(t,i+n+r)}appendAttribute(e,t,i,r,n){e.setAttribute(t,r+n+i)}maybeUnwrapArtificial(e){if(!this.isDomEntity(e))return e;const t=document.createDocumentFragment(),i=(e,t)=>{e.nodeType===Node.DOCUMENT_FRAGMENT_NODE||e.nodeType===Node.ELEMENT_NODE&&e.isArtificialWrapper?Array.from(e.childNodes).forEach((e=>i(e,t))):(t.appendChild(e),Array.from(e.childNodes).forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&e.isArtificialWrapper&&e.replaceWith(...Array.from(e.childNodes))})))};return e instanceof NodeList||e instanceof HTMLCollection?Array.from(e).forEach((e=>i(e,t))):i(e,t),t}replace(e,t,i,r,n,a,s){let l="innerHTML"===t||n,o=l?"innerHTML":"outerHTML",d=i[o];if("replaceSubstring"===e&&s&&(r=this.substringReplace(d,s,r)),this.isUndoAble(a))if(l){if(this.addUndo(i,a,{action:"replace",aspect:"innerHTML",liveEl:this.detach(i,!0)}),this.isDomEntity(r)?(i.innerHTML="",i.appendChild(this.maybeUnwrapArtificial(r))):i.innerHTML=r,i.children)for(const e of i.children)this.elementData.attach(e,a.mod.snippet_id,a.isUndo)}else{const e=i.parentNode,n=i.nextElementSibling;let s=this.detach(i);if(n)this.insert("insertBefore","html",n,r,null,{noUndo:1,mod:{snippet_id:a.mod.snippet_id}}),i=n.previousSibling;else{if(!e)return;this.insert("append","html",e,r,null,{noUndo:1,mod:{snippet_id:a.mod.snippet_id}}),i=e.lastChild}i.isConnected&&this.elementData.attach(i,a.mod.snippet_id,a.isUndo),this.addUndo(i,a,{action:"replace",aspect:t,liveEl:s})}else i[o]=r}substringReplace(e,t,i){let r;if("string"==typeof t&&t.startsWith("/")){const e=t.match(/^\/(.*)\/([a-z]*)$/);e&&(r=new RegExp(e[1],e[2]))}else r=t instanceof RegExp?t:new RegExp(t,"g");return e.replace(r,i)}lazyLoad(e,t,i,r,n,a){if(r&&e.lazy_id&&"html"===i){let n=this.isEditing?"[content will <b>lazyLoad</b> and be <b>publicly accessible</b>]":"",s='<div class="lazy-placeholder" data-lazy-id="'+e.lazy_id+'">'+n+"</div>";this.replace(t,i,r,s,!1,a)}}resolveDestEl(e,t){let i=t.move_to_selector||"",r=this.TvrEventManager.isValidSelector(i),n=t.move_relative_dom?JSON.parse(t.move_relative_dom):{iterate:[]},a=this;return t.destLiveEl?t.destLiveEl:n.iterate&&n.iterate.length?(n.iterate.forEach((function(t){let i=t.selector||"",r=""===i.trim()?"*":i.trim();if(e)switch(t.directive){case"parent":e=e.parentElement;break;case"parents":e=a.getParents(e,r);break;case"closest":e=e.closest(r);break;case"children":e=Array.from(e.children).filter((e=>e.matches(r)));break;case"find":e=e.querySelector(r);break;case"next":e=e.nextElementSibling&&e.nextElementSibling.matches(r)?e.nextElementSibling:null;break;case"prev":e=e.previousElementSibling&&e.previousElementSibling.matches(r)?e.previousElementSibling:null;break;case"siblings":e=a.getSiblings(e).filter((e=>e.matches(r)))}})),NodeList.prototype.isPrototypeOf(e)||Array.isArray(e)?e.length>0?e[0]:null:e):r?document.querySelector(i):null}getParents(e,t){const i=[];let r=e.parentElement;for(;r&&r!==document;)r.matches(t)&&i.push(r),r=r.parentElement;return i}getSiblings(e){return Array.from(e.parentElement.children).filter((t=>t!==e))}move(e,t,i,r,n){let a=n.mod,s=this.resolveDestEl(i,a),l=a.move_action||"append",o=n.mod.snippet_id;if(n.move=1,s&&s.tagName){let a={undo:[],mod:{snippet_id:o,action:l,aspect:t,liveEl:this.remove(e,t,i,r,n)}};this.execute(a,s,{}),this.elementData.attach(s,o,n.isUndo),n.undo="text"===t||"innerHTML"===t?[{action:"move",aspect:"innerHTML",elements:a.undo[0].elements,destLiveEl:i}]:n.undo.concat(a.undo)}return s}remove(e,t,i,r,n){let a;if(i){let e="innerHTML"===t||r,s=this.isUndoAble(n);if(s||n.move){let r,l;e?(r="prepend",l=i,a=this.detach(i,!0)):(i.nextSibling?(r="insertBefore",l=i.nextSibling):(r="append",l=i.parentNode),a=this.detach(i)),s&&this.addUndo(l,n,{action:r,aspect:t,liveEl:a})}else e?i.innerHTML="":i.remove()}return a}detach(e,t=!1){if(!e.parentElement)return e;if(t){const t=document.createDocumentFragment();for(;e.firstChild;){let i=e.firstChild;if(i.nodeType===Node.TEXT_NODE&&""!==i.textContent.trim()){const e=document.createElement("span");e.appendChild(i),e.isArtificialWrapper=!0,t.appendChild(e)}else t.appendChild(i)}return t}return e.parentElement.removeChild(e)}addWrapper(e,t,i,r,n,a){let s;if(e.mod.liveEl?(s=e.mod.liveEl,n=""):s=document.createElement(r),this.elementData.attach(i,e.mod.snippet_id,e.isUndo),this.elementData.attach(s,e.mod.snippet_id,e.isUndo),n&&this.applyAttributesFromString(s,n),a)i.parentNode.insertBefore(s,i),Array.isArray(e.mod.siblings)?e.mod.siblings.forEach((e=>s.appendChild(e))):s.appendChild(i),this.addUndo(i,e,{action:"remove",aspect:t});else{for(;i.firstChild;)s.appendChild(i.firstChild);i.appendChild(s),this.addUndo(i,e,{action:"remove",aspect:t})}}removeWrapper(e,t,i,r){let n,a,s;if(r){if(n=i&&i.parentNode,n&&n.parentNode){const e=n.parentNode;for(s=Array.from(n.childNodes);n.firstChild;)e.insertBefore(n.firstChild,n);a=!0}}else if(n=i&&i.firstElementChild,n){for(;n.firstChild;)i.insertBefore(n.firstChild,n);a=!0}a&&n&&(this.isUndoAble(e)?this.addUndo(i,e,{action:"add",aspect:t,liveEl:this.detach(n),siblings:s}):n.remove&&n.remove())}removeWrapperAI(e,t,i,r){let n,a;if(r&&(n=i&&i.parentNode,n&&n.parentNode)){const r=n.parentNode,s=Array.from(n.childNodes);for(;n.firstChild;)r.insertBefore(n.firstChild,n);if(a=!0,a){const r=this.detach(n);this.isUndoAble(e)?this.addUndo(i,e,{action:"add",aspect:t,liveEl:r,siblings:s}):r&&r.remove&&r.remove()}}else{if(n=i&&i.firstElementChild,n){for(;n.firstChild;)i.insertBefore(n.firstChild,n);a=!0}a&&(this.isUndoAble(e)?this.addUndo(i,e,{action:"add",aspect:t,liveEl:this.detach(n)}):n&&n.remove&&n.remove())}}isAttribute(e){return new Set(["accept","accept-charset","accesskey","action","allow","alpha","alt","as","async","autocapitalize","autocomplete","autoplay","capture","charset","checked","cite","class","colorspace","cols","colspan","content","contenteditable","controls","coords","crossorigin","csp","datetime","decoding","default","defer","dir","dirname","disabled","download","draggable","enctype","enterkeyhint","elementtiming","for","form","formaction","formenctype","formmethod","formnovalidate","formtarget","headers","height","hidden","high","href","hreflang","http-equiv","id","integrity","inputmode","ismap","itemprop","kind","label","lang","loading","list","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","novalidate","open","optimum","pattern","ping","placeholder","playsinline","poster","preload","readonly","referrerpolicy","rel","required","reversed","role","rows","rowspan","sandbox","scope","selected","shape","size","sizes","slot","span","spellcheck","src","srcdoc","srclang","srcset","start","step","style","tabindex","target","title","translate","type","usemap","value","width","wrap"]).has(e)||/^(?:data|x|hx|ng|v|aria)-[^\s"'<>\/=]+$/.test(e)}getAllAttributes(e){return Array.from(e.attributes).map((e=>`${e.name}="${e.value}"`)).join(" ")}removeAllAttributes(e){if(e&&e.attributes)for(;e.attributes.length>0;)e.removeAttribute(e.attributes[0].name);return""}applyAttributesFromString(e,t){const i=document.createElement("div");i.innerHTML=`<div ${t}></div>`;const r=i.firstElementChild.attributes;if(r)for(let t=0;t<r.length;t++){const i=r[t],n=i.name;n&&0!==n.indexOf("=")&&e.setAttribute(i.name,i.value)}}}