import VisibilityObserver from"./mt-visibility-observer.js";import ApplyMod from"./mt-apply-mod.js";class TvrEventManager{constructor(e){this.amender=window.amender||{},this.isEditing=this.amender.isEditing,this.eventData=this.amender.mods,this.ensureModsIsArray(),this.amender.noAmends||(this.amender.debugAmends&&(window.MTDebugServerPerformance=1),this.selectorCache={},this.uniqueSelectors={},this.visibilityObserver=new VisibilityObserver({},this.uniqueSelectors,this),this.applyMod=new ApplyMod(this),this.attachedListeners=new WeakMap,addEventListener("DOMContentLoaded",(e=>{this.applyEventListeners()})))}isViewEvent(e){return["inview","outview"].includes(e)}getMTReferences(){let e=!!window.getMTWindow&&window.getMTWindow(),t=!!e&&e.TvrMT;return{MTWindow:e,TvrMT:t,TvrUi:!!t&&t.TvrUi}}getNamespacedEventType(e){return e}getElementListeners(e){return this.attachedListeners.has(e)||this.attachedListeners.set(e,new Set),this.attachedListeners.get(e)}isValidSelector(e){if(!e)return!1;if(this.selectorCache.hasOwnProperty(e))return this.selectorCache[e];const t=e.split(",").map((e=>e.trim())).every((e=>CSS.supports("selector("+e+")")));return this.selectorCache[e]=t,t}collectUniqueSelectors(e){this.uniqueSelectors[e]=new Set,Object.keys(this.eventData[e]).forEach((t=>{Object.keys(this.eventData[e][t]).forEach((s=>{const i=this.eventData[e][t][s].selectorCode;this.eventData[e][t][s].mods.forEach((t=>{const s=t.mod.selector||i;this.isValidSelector(s)&&this.uniqueSelectors[e].add(s)}))}))}))}attachUniqueLister(e,t,s,i){const n=this.getNamespacedEventType(t),r=this.getElementListeners(e);r.has(n)||(i?this.visibilityObserver.observeElementForInView(e,(t=>{t&&s({target:e})})):e.addEventListener(n,(e=>{s(e)})),r.add(n))}applyEventListeners(e){this.getOrderedEventKeys(this.eventData).forEach((t=>{this.isDomEvent(t)?this.respondToEvent(t,document.documentElement,{isDomEvent:1},e):this.isViewEvent(t)?(this.collectUniqueSelectors(t),this.setupInViewEvent(t,e)):["mouseenter","mouseleave","focus","blur","load","scroll","error","abort","reset","submit","selectionchange"].includes(t)?(this.collectUniqueSelectors(t),this.setupNonBubblingEvent(t,e)):this.setupBubblingEvent(t,e)})),this.initialModsDone=!0}setupBubblingEvent(e,t){this.attachUniqueLister(document.documentElement,e,(s=>this.respondToEvent(e,document.documentElement,s,t)))}getNonBubblingElements(e){const t=Array.from(this.uniqueSelectors[e]).join(", ");if(t)return document.querySelectorAll(t)}setupNonBubblingEvent(e,t){const s=this.getNonBubblingElements(e);s&&s.forEach((s=>{this.attachUniqueLister(s,e,(i=>this.respondToEvent(e,s,i,t)))}))}setupInViewEvent(e,t){const s=this.getNonBubblingElements(e);s&&s.forEach((s=>{this.attachUniqueLister(s,e,(i=>this.respondToEvent(e,s,i,t)),!0)}))}getOrderedEventKeys(e,t){const s=Object.keys(e),i=[];return["serverHTMLReady","DOMContentLoaded","load","inview","outview","mouseenter","mouseover","mousemove","mousedown","click","mouseup","mouseleave","mouseout","focus","input","select","change","blur","keydown","keypress","keyup","submit","reset","beforeunload","unload"].forEach((e=>{const t=s.indexOf(e);-1!==t&&(i.push(e),s.splice(t,1))})),i.push(...s),t&&i.reverse(),i}isDomEvent(e){return"DOMContentLoaded"===e||"serverHTMLReady"===e}beforeEvent(e,t,s){}afterEvent(e,t,s){}respondToEvent(e,t,s,i){let n=this.isDomEvent(e);this.beforeEvent(e,t,s),this.iterateEventData(e,"forwards",((t,r,o,a,d)=>{if(!(a.meta.finished||i&&"same"===i[t])&&this.isValidSelector(d))if(n){let t=document.querySelectorAll(d);t&&t.forEach(((t,s)=>{this.applyMod.execute(a,t,{isDomEvent:1},e)}))}else{let t=s.target;t.matches(d)&&(this.applyMod.execute(a,t,s,e),a.meta?.once&&(a.meta.finished=!0))}})),this.afterEvent(e,t,s)}iterateEventData(e,t,s,i){if(!this.eventData[e])return;let n=Object.keys(this.eventData[e]);"reverse"===t&&(n=n.reverse()),n.forEach((n=>{if(this.isMediaMatch(n)||i){let r=Object.keys(this.eventData[e][n]);"reverse"===t&&(r=r.reverse()),r.forEach((r=>{const o=this.eventData[e][n][r].selectorCode;let a=this.eventData[e][n][r].mods;if(i&&a&&"object"==typeof a&&!Array.isArray(a)){const t=[];Object.entries(a).forEach((([e,s])=>{t[parseInt(e)]=s})),a=t,this.eventData[e][n][r].mods=t}if(s){let i=Object.keys(a);"reverse"===t&&(i=i.reverse()),i.forEach((t=>{const i=a[t],d=[e,n,r,"mods",t].join("|");s(d,n,r,i,i.mod.selector||o)}))}}))}}))}ensureModsIsArray(){this.modsTypeFixDone||(this.getOrderedEventKeys(this.eventData,!0).forEach((e=>{this.iterateEventData(e,"forward",null,!0)})),this.modsTypeFixDone=!0)}updateModKeys(e,t,s,i=null){let n,r,o=!1,a={};"section"===s?(n="^"+e+"-",r=t+"-"):(n="^"+e+"$",r=t);let d=new RegExp(n);this.getOrderedEventKeys(this.eventData,!0).forEach((e=>{this.iterateEventData(e,"forwards",((t,s,i,n,c)=>{i.match(d)&&(i=i.replace(d,r),o=!0),a[e]||(a[e]={}),a[e][s]||(a[e][s]={}),a[e][s][i]||(a[e][s][i]={selectorCode:c,mods:[]});const h=parseInt(t.split("|").pop());a[e][s][i].mods[h]=n}))})),this.updateModReferences(a)}updateMods(e){let t={};this.getOrderedEventKeys(this.eventData,!0).forEach((s=>{this.iterateEventData(s,"reverse",((i,n,r,o,a)=>{if("same"!==(e.comparison[i]||"removed")){Object.keys(o.undo).reverse().forEach((e=>{this.applyMod.undo(o.undo[e],s),"inview"===s&&this.isValidSelector(a)&&(t[a]=1)}));let i=o.mod?.aspect;"js"!==i&&"jsFunction"!==i||(e.requiresPageRefresh=1)}}))}));let s=Object.keys(t);if(s.length){let e=document.querySelectorAll(s.join(", "));e&&e.forEach((e=>{this.visibilityObserver.unobserveElement(e)}))}this.amender.snippets=e.snippets,this.updateModReferences(e.mods),this.applyEventListeners(e.comparison)}updateModReferences(e){window.amender.mods=e,this.eventData=window.amender.mods}isMediaMatch(e){if("all-devices"===e)return!0;let t=e.replace("@media","");return window.matchMedia(t).matches}}window.TvrEventManagerInstance=new TvrEventManager(window.amender.mods);